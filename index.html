<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Retirement Readiness Calculator</title>

  <style>
    :root{
      /* ‚úÖ Light theme tokens */
      --text:#0f172a;
      --muted:#475569;

      --border: rgba(15,23,42,.10);
      --shadow: 0 18px 45px rgba(15,23,42,.10);
      --radius: 18px;

      --card: rgba(255,255,255,.86);

      --brand: #6366f1;      /* indigo */
      --good:#16a34a;        /* green */
      --warn:#f59e0b;        /* amber */
      --bad:#ef4444;         /* red */

      --focus: 0 0 0 4px rgba(99,102,241,.18);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);

      /* ‚úÖ Softer gradient background */
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(900px 520px at 95% 10%, rgba(34,197,94,.12), transparent 55%),
        radial-gradient(700px 520px at 50% 95%, rgba(59,130,246,.10), transparent 60%),
        linear-gradient(180deg, #f8fafc 0%, #f1f5f9 60%, #eef2ff 100%);

      padding: 26px 16px 96px;
    }

    .wrap{ max-width: 920px; margin: 0 auto; }

    /* Hero */
    .hero{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.55));
      box-shadow: var(--shadow);
      border-radius: 22px;
      padding: 18px 18px 14px;
      position: relative;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(650px 240px at 30% 0%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(550px 240px at 80% 20%, rgba(34,197,94,.10), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .hero > *{ position:relative; z-index:1; }

    .hero-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{ margin:0; font-size: 26px; letter-spacing: .2px; }
    .subtitle{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 14.5px;
      line-height: 1.4;
      max-width: 70ch;
    }
    .subtitle b{ color: var(--text); font-weight: 900; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.75);
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
      backdrop-filter: blur(10px);
    }
    .pill b{ color: var(--text); }

    /* Steps */
    .steps{ margin-top: 14px; }
    .stepbar{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .step{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.70);
      border-radius: 14px;
      padding: 10px;
      min-height: 54px;
      backdrop-filter: blur(10px);
    }
    .step .k{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:4px; }
    .step .num{
      width: 26px; height: 26px; border-radius: 10px;
      display:grid; place-items:center;
      font-weight: 950; font-size: 13px;
      background: rgba(99,102,241,.16);
      border: 1px solid rgba(99,102,241,.28);
      color: rgba(15,23,42,.88);
    }
    .step .label{ font-weight: 900; font-size: 13px; letter-spacing: .2px; }
    .step .desc{ margin:0; color: var(--muted); font-size: 12.5px; line-height: 1.35; }

    /* Main layout (1 column always) */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .card{
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 16px;
      backdrop-filter: blur(10px);
    }

    .cardhead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap:wrap;
    }
    .cardtitle{
      display:flex;
      align-items:center;
      gap: 10px;
      margin: 0;
      font-size: 17px;
      letter-spacing: .2px;
    }
    .icon{
      width: 34px; height: 34px;
      border-radius: 12px;
      display:grid; place-items:center;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      font-size: 18px;
    }
    .hint{ color: var(--muted); font-size: 12.5px; margin: 0; }
    .hint b{ color: var(--text); font-weight: 900; }

    .fields{ display:grid; gap: 12px; }

    label{
      display:block;
      font-weight: 950;
      font-size: 14.5px;
      letter-spacing: .15px;
      margin: 0 0 8px;
      color: rgba(15,23,42,.92);
    }

    input, select{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.92);
      color: var(--text);
      font-size: 15px;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input::placeholder{ color: rgba(71,85,105,.65); }
    input:focus, select:focus{
      border-color: rgba(99,102,241,.65);
      box-shadow: var(--focus);
    }
    input:disabled{ opacity: .55; cursor:not-allowed; }

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .chk{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.75);
      color: rgba(15,23,42,.90);
      font-weight: 900;
      font-size: 13px;
      user-select:none;
      white-space:nowrap;
      backdrop-filter: blur(10px);
    }
    .chk input{
      width: 16px; height: 16px; margin:0;
      accent-color: var(--brand);
    }

    /* Sticky action bar */
    .bar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 12px 12px 14px;
      background: rgba(248,250,252,.78);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(15,23,42,.10);
      z-index: 50;
    }
    .bar .inner{
      max-width: 920px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    button{
      width: 100%;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.90);
      color: var(--text);
      font-weight: 950;
      font-size: 15px;
      letter-spacing: .2px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    button:active{ transform: translateY(1px); }

    .primary{
      background: linear-gradient(135deg, rgba(99,102,241,.98), rgba(59,130,246,.92));
      border-color: rgba(99,102,241,.45);
      box-shadow: 0 14px 24px rgba(99,102,241,.22);
      color: white;
    }
    .primary:hover{
      box-shadow: 0 18px 30px rgba(99,102,241,.28);
      border-color: rgba(99,102,241,.70);
    }
    .ghost:hover{
      background: rgba(15,23,42,.04);
      border-color: rgba(15,23,42,.14);
    }

    /* ===== Output (Centered + Emphasis) ===== */
    .result{
      display:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow);
      border-radius: 22px;
      padding: 18px;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    .resultHero{
      border: 1px solid rgba(15,23,42,.10);
      background:
        radial-gradient(800px 250px at 50% 0%, rgba(99,102,241,.16), transparent 55%),
        rgba(255,255,255,.75);
      border-radius: 22px;
      padding: 16px;
    }
    .resultHeroTop{ display:grid; gap: 10px; justify-items: center; }

    .resultBadge{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 950;
      letter-spacing: .2px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .resultBadge .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      box-shadow: 0 0 0 4px rgba(15,23,42,.04);
    }
    .resultBadge.good .dot{ background: var(--good); }
    .resultBadge.warn .dot{ background: var(--warn); }
    .resultBadge.bad  .dot{ background: var(--bad); }

    .resultMsg{
      margin: 10px auto 0;
      max-width: 74ch;
      color: rgba(71,85,105,.95);
      font-size: 15px;
      line-height: 1.5;
    }
    .resultMsg b{ color: var(--text); font-weight: 950; }

    .metrics{
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      text-align:left;
    }
    .metric{
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.85);
      border-radius: 16px;
      padding: 12px;
      min-height: 86px;
      backdrop-filter: blur(10px);
    }
    .metric .k{ margin: 0 0 6px; font-size: 12.5px; color: rgba(71,85,105,.90); }
    .metric .v{ margin: 0; font-size: 18px; font-weight: 950; letter-spacing: .2px; }
    .metric .s{ margin: 6px 0 0; font-size: 12.5px; color: rgba(71,85,105,.78); font-family: var(--mono); }

    .breakdown{
      margin-top: 14px;
      text-align: left;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.80);
      border-radius: 18px;
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .breakdown h4{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing: .2px;
      color: rgba(15,23,42,.92);
    }
    .breakdownGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .item{
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.88);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .item .label{ margin: 0 0 6px; font-size: 12.5px; color: rgba(71,85,105,.90); }
    .item .value{ margin: 0; font-weight: 950; letter-spacing: .2px; }
    .item .sub{ margin: 6px 0 0; font-size: 12.5px; color: rgba(71,85,105,.78); font-family: var(--mono); }

    /* Dropdown (Method & Calculation) */
    .details{
      margin-top: 14px;
      text-align: left;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.80);
      border-radius: 18px;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    .details summary{
      cursor: pointer;
      list-style: none;
      padding: 12px 14px;
      font-weight: 950;
      color: rgba(15,23,42,.92);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .details summary::-webkit-details-marker{ display:none; }
    .details summary .chev{ opacity: .85; transition: transform .15s ease; }
    .details[open] summary .chev{ transform: rotate(180deg); }
    .details .content{
      padding: 0 14px 14px;
      color: rgba(71,85,105,.95);
      font-size: 13.5px;
      line-height: 1.5;
    }
    .details code{
      font-family: var(--mono);
      color: rgba(15,23,42,.92);
    }

    /* ===== Ring Gauge ===== */
    .gaugeWrap{ display:grid; place-items:center; margin-top: 6px; }
    .gauge{ width: 190px; height: 190px; position: relative; display:grid; place-items:center; }
    .gauge svg{
      width: 190px; height: 190px;
      transform: rotate(-90deg);
      filter: drop-shadow(0 10px 22px rgba(15,23,42,.10));
    }
    .gauge .track{ stroke: rgba(15,23,42,.08); stroke-width: 14; fill: none; }
    .gauge .progress{
      stroke: rgba(99,102,241,.95);
      stroke-width: 14; fill: none;
      stroke-linecap: round;
      transition: stroke-dashoffset .7s ease, stroke .25s ease;
    }
    .gauge.good .progress{ stroke: rgba(22,163,74,.95); }
    .gauge.warn .progress{ stroke: rgba(245,158,11,.95); }
    .gauge.bad  .progress{ stroke: rgba(239,68,68,.95); }

    /* ‚úÖ Updated center alignment (ratio now visually centered in circle) */
    .gaugeCenter{
      position:absolute;
      inset: 0;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      text-align:center;
      pointer-events:none;
      transform: translateY(2px);
    }
    .gaugeValue{
      font-size: 30px;
      font-weight: 1000;
      letter-spacing: .3px;
      margin: 0;
      line-height: 1.05;
    }
    .gaugeLabel{
      margin: 6px 0 0;
      font-size: 12.5px;
      font-weight: 850;
      color: var(--muted);
      line-height: 1.2;
    }

    .gaugeHint{
      margin: 8px auto 0;
      font-size: 12.5px;
      color: rgba(71,85,105,.92);
      max-width: 60ch;
      text-align:center;
    }
    .gaugeHint b{ color: var(--text); font-weight: 950; }

    /* Responsive */
    @media (max-width: 820px){
      .metrics{ grid-template-columns: 1fr 1fr; }
      .breakdownGrid{ grid-template-columns: 1fr; }
      .stepbar{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
      .chk{ width: 100%; justify-content:flex-start; }
      .two{ grid-template-columns: 1fr; }
      .bar .inner{ grid-template-columns: 1fr; }
      .metrics{ grid-template-columns: 1fr; }
      .gauge{ width: 170px; height: 170px; }
      .gauge svg{ width: 170px; height: 170px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <section class="hero">
      <div class="hero-top">
        <div>
          <h1 class="title">Retirement Readiness Calculator</h1>
          <p class="subtitle">
            A clean, simple check to estimate if you‚Äôre <b>on track</b>. Results are illustrative and <b>not guaranteed</b>.
          </p>
        </div>
        <div class="pill">üîí Educational ‚Ä¢ <b>Not advice</b></div>
      </div>

      <div class="steps">
        <div class="stepbar">
          <div class="step"><div class="k"><span class="num">1</span><span class="label">Basics</span></div><p class="desc">Ages & timeline.</p></div>
          <div class="step"><div class="k"><span class="num">2</span><span class="label">Lifestyle</span></div><p class="desc">Income goal.</p></div>
          <div class="step"><div class="k"><span class="num">3</span><span class="label">Assets</span></div><p class="desc">CPF & others.</p></div>
          <div class="step"><div class="k"><span class="num">4</span><span class="label">Result</span></div><p class="desc">Gauge & breakdown.</p></div>
        </div>
      </div>
    </section>

    <section class="grid">
      <!-- Basics -->
      <div class="card">
        <div class="cardhead">
          <h3 class="cardtitle"><span class="icon">üß≠</span> Step 1 ‚Äî Basics</h3>
          <p class="hint">Keep it <b>simple</b>. You can refine later.</p>
        </div>
        <div class="fields">
          <div class="two">
            <div>
              <label for="currentAge">Current age</label>
              <input id="currentAge" type="number" inputmode="numeric" min="18" max="90" placeholder="e.g. 45" />
            </div>
            <div>
              <label for="retireAge">Target retirement age</label>
              <input id="retireAge" type="number" inputmode="numeric" min="30" max="90" placeholder="e.g. 65" />
            </div>
          </div>

          <div>
            <label for="longevityAge">Plan income to age</label>
            <select id="longevityAge">
              <option value="85">85</option>
              <option value="90">90</option>
              <option value="95" selected>95 (recommended)</option>
              <option value="100">100</option>
            </select>
            <p class="hint" style="margin-top:8px;">If unsure, keep <b>95</b>.</p>
          </div>
        </div>
      </div>

      <!-- Lifestyle -->
      <div class="card">
        <div class="cardhead">
          <h3 class="cardtitle"><span class="icon">üí≥</span> Step 2 ‚Äî Lifestyle target</h3>
          <p class="hint">Enter in <b>today‚Äôs dollars</b>.</p>
        </div>
        <div class="fields">
          <div>
            <label for="monthlyIncome">Desired retirement income per month (today‚Äôs dollars)</label>
            <input id="monthlyIncome" type="number" inputmode="numeric" min="0" step="100" placeholder="e.g. 4,000" />
            <p class="hint" style="margin-top:8px;">We‚Äôll adjust it using <b>inflation</b>.</p>
          </div>
        </div>
      </div>

      <!-- CPF -->
      <div class="card">
        <div class="cardhead">
          <h3 class="cardtitle"><span class="icon">üè¶</span> Step 3 ‚Äî CPF balances (OA / SA)</h3>
          <p class="hint">You can edit the <b>growth rates</b>.</p>
        </div>

        <div class="fields">
          <div class="two">
            <div>
              <label for="cpfOA">CPF OA balance (today)</label>
              <div class="row">
                <input id="cpfOA" type="number" inputmode="numeric" min="0" step="1000" placeholder="e.g. 80,000" />
                <label class="chk"><input id="cpfOAUnknown" type="checkbox" /> Not sure</label>
              </div>
            </div>

            <div>
              <label for="cpfSA">CPF SA balance (today)</label>
              <div class="row">
                <input id="cpfSA" type="number" inputmode="numeric" min="0" step="1000" placeholder="e.g. 120,000" />
                <label class="chk"><input id="cpfSAUnknown" type="checkbox" /> Not sure</label>
              </div>
            </div>
          </div>

          <div class="two">
            <div>
              <label for="oaRate">OA growth rate (annual %)</label>
              <input id="oaRate" type="number" inputmode="decimal" min="0" step="0.1" value="2.5" />
            </div>
            <div>
              <label for="saRate">SA growth rate (annual %)</label>
              <input id="saRate" type="number" inputmode="decimal" min="0" step="0.1" value="4.0" />
            </div>
          </div>

          <p class="hint">‚ÄúNot sure‚Äù is treated as <b>0</b> (conservative).</p>
        </div>
      </div>

      <!-- Non-CPF assets + savings -->
      <div class="card">
        <div class="cardhead">
          <h3 class="cardtitle"><span class="icon">üìà</span> Step 4 ‚Äî Non-CPF assets & contributions</h3>
          <p class="hint">Investments compound with <b>expected returns</b>.</p>
        </div>

        <div class="fields">
          <div>
            <label for="cash">Cash / savings (today)</label>
            <div class="row">
              <input id="cash" type="number" inputmode="numeric" min="0" step="1000" placeholder="e.g. 50,000" />
              <label class="chk"><input id="cashUnknown" type="checkbox" /> Not sure</label>
            </div>
          </div>

          <div>
            <label for="invest">Investments (today)</label>
            <div class="row">
              <input id="invest" type="number" inputmode="numeric" min="0" step="1000" placeholder="e.g. 150,000" />
              <label class="chk"><input id="investUnknown" type="checkbox" /> Not sure</label>
            </div>
          </div>

          <div class="two">
            <div>
              <label for="monthlySavings">Monthly savings / investing (excluding CPF)</label>
              <input id="monthlySavings" type="number" inputmode="numeric" min="0" step="50" placeholder="e.g. 1,000" />
            </div>
            <div>
              <label for="investReturn">Expected investment return (annual %)</label>
              <input id="investReturn" type="number" inputmode="decimal" min="0" step="0.1" value="5.0" />
            </div>
          </div>

          <p class="hint">Cash is assumed to have <b>0% growth</b> (simple model).</p>
        </div>
      </div>

      <!-- Assumptions -->
      <div class="card">
        <div class="cardhead">
          <h3 class="cardtitle"><span class="icon">‚öôÔ∏è</span> Step 5 ‚Äî Key assumptions</h3>
          <p class="hint">These change results a lot. Keep them <b>reasonable</b>.</p>
        </div>

        <div class="fields">
          <div class="two">
            <div>
              <label for="inflation">Inflation (annual %)</label>
              <input id="inflation" type="number" inputmode="decimal" min="0" step="0.1" value="2.5" />
            </div>
            <div>
              <label for="retireReturn">Retirement return (annual %)</label>
              <input id="retireReturn" type="number" inputmode="decimal" min="0" step="0.1" value="3.0" />
            </div>
          </div>

          <p class="hint">
            Inflation grows your <b>income need</b>. Retirement return affects how much capital is needed to fund it.
          </p>
        </div>
      </div>

      <!-- Optional feelings -->
      <div class="card">
        <div class="cardhead">
          <h3 class="cardtitle"><span class="icon">üß†</span> Optional ‚Äî Feelings & concerns</h3>
          <p class="hint">Does not change maths.</p>
        </div>

        <div class="fields">
          <div class="two">
            <div>
              <label for="confidence">How confident do you feel?</label>
              <select id="confidence">
                <option value="">‚Äî Select (optional) ‚Äî</option>
                <option value="confident">Confident</option>
                <option value="unsure">Somewhat unsure</option>
                <option value="worried">Worried</option>
              </select>
            </div>
            <div>
              <label for="concern">Biggest concern</label>
              <select id="concern">
                <option value="">‚Äî Select (optional) ‚Äî</option>
                <option value="saving">Not saving enough</option>
                <option value="inflation">Inflation / rising costs</option>
                <option value="cpf">CPF / CPF LIFE confusion</option>
                <option value="volatility">Investment volatility</option>
                <option value="healthcare">Healthcare costs</option>
                <option value="start">Not sure where to start</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Result -->
      <div id="output" class="result"></div>

      <!-- Disclaimer always visible at end -->
      <div class="card">
        <p class="hint" style="font-size:13.5px; line-height:1.5; margin:0;">
          <b>Disclaimer:</b> This calculator provides a simplified educational estimate only. It does not account for taxes,
          healthcare shocks, CPF LIFE specifics, property income, insurance, changes in salary, or market volatility.
          Results are illustrative and <b>not guaranteed</b>. This is <b>not financial advice</b>.
        </p>
      </div>
    </section>
  </div>

  <!-- Sticky actions -->
  <div class="bar">
    <div class="inner">
      <button class="primary" id="calcBtn">Calculate</button>
      <button class="ghost" id="resetBtn" type="button">Reset</button>
    </div>
  </div>

  <script>
    // Helpers
    const $ = (id) => document.getElementById(id);

    function toNumber(value) {
      const n = Number(String(value ?? "").replace(/,/g, ""));
      return Number.isFinite(n) ? n : 0;
    }
    function pctToRate(p){ return toNumber(p) / 100; }
    function clampMin(n, min){ return n < min ? min : n; }
    function fmtMoney(n){
      const v = Number.isFinite(n) ? n : 0;
      return v.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }
    function disableIfUnknown(inputId, unknownId) {
      const input = $(inputId);
      const chk = $(unknownId);
      const sync = () => {
        input.disabled = chk.checked;
        if (chk.checked) input.value = "";
      };
      chk.addEventListener("change", sync);
      sync();
    }

    // Unknown toggles
    disableIfUnknown("cpfOA", "cpfOAUnknown");
    disableIfUnknown("cpfSA", "cpfSAUnknown");
    disableIfUnknown("cash", "cashUnknown");
    disableIfUnknown("invest", "investUnknown");

    // Gauge painter
    function paintGauge(status, ratio) {
      const gauge = document.querySelector(".gauge");
      if (!gauge) return;

      gauge.classList.remove("good","warn","bad");
      gauge.classList.add(status);

      gauge.dataset.ratio = String(ratio);

      const cap = 1.8; // cap at 1.8√ó for visual
      const pct = Math.max(0, Math.min(ratio / cap, 1));

      const circumference = 502.65;
      const offset = circumference * (1 - pct);

      const progress = gauge.querySelector(".progress");
      if (!progress) return;

      progress.style.strokeDashoffset = offset.toFixed(2);
    }

    function renderErrors(errors){
      const output = $("output");
      output.style.display = "block";
      output.innerHTML = `
        <div class="resultHero">
          <div class="resultHeroTop">
            <div class="resultBadge warn"><span class="dot"></span> Needs input</div>
            <p class="resultMsg">
              Please fix the items below so we can compute a meaningful estimate.
            </p>
          </div>
        </div>

        <div class="breakdown" style="margin-top:14px;">
          <h4>Missing / invalid fields</h4>
          <ul style="margin:0; padding-left:18px; color:rgba(15,23,42,.92); font-size:14px;">
            ${errors.map(e => `<li style="margin:6px 0;">${e}</li>`).join("")}
          </ul>
        </div>
      `;
      output.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function calculate(){
      const currentAge = toNumber($("currentAge").value);
      const retireAge  = toNumber($("retireAge").value);
      const longevityAge = toNumber($("longevityAge").value);

      const monthlyIncomeToday = toNumber($("monthlyIncome").value);
      const monthlySavings = toNumber($("monthlySavings").value);

      const oaRate = pctToRate($("oaRate").value);
      const saRate = pctToRate($("saRate").value);

      const inflation = pctToRate($("inflation").value);
      const investReturn = pctToRate($("investReturn").value);
      const retireReturn = pctToRate($("retireReturn").value);

      const errors = [];
      if (currentAge <= 0) errors.push("Enter your current age.");
      if (retireAge <= 0) errors.push("Enter your target retirement age.");
      if (currentAge > 0 && retireAge > 0 && retireAge <= currentAge) errors.push("Retirement age must be greater than current age.");
      if (monthlyIncomeToday <= 0) errors.push("Enter your desired retirement income per month (today‚Äôs dollars).");
      if (longevityAge <= retireAge) errors.push("‚ÄúPlan income to age‚Äù must be higher than retirement age.");
      if (monthlySavings < 0) errors.push("Monthly savings cannot be negative.");
      if (oaRate < 0 || saRate < 0) errors.push("CPF growth rates cannot be negative.");
      if (inflation < 0) errors.push("Inflation cannot be negative.");
      if (investReturn < 0 || retireReturn < 0) errors.push("Returns cannot be negative (in this simplified model).");

      if (errors.length) return renderErrors(errors);

      const yearsToRetire = retireAge - currentAge;
      let retirementYears = longevityAge - retireAge;
      retirementYears = clampMin(retirementYears, 1);

      // Inflate income from today -> retirement start
      const incomeAtRetireMonthly = monthlyIncomeToday * Math.pow(1 + inflation, yearsToRetire);
      const incomeAtRetireAnnual = incomeAtRetireMonthly * 12;

      // CPF OA/SA growth
      const oaNow = $("cpfOAUnknown").checked ? 0 : toNumber($("cpfOA").value);
      const saNow = $("cpfSAUnknown").checked ? 0 : toNumber($("cpfSA").value);

      const oaRet = oaNow * Math.pow(1 + oaRate, yearsToRetire);
      const saRet = saNow * Math.pow(1 + saRate, yearsToRetire);
      const cpfRet = oaRet + saRet;

      // Non-CPF assets
      const cashNow = $("cashUnknown").checked ? 0 : toNumber($("cash").value);
      const investNow = $("investUnknown").checked ? 0 : toNumber($("invest").value);

      // Investments grow + monthly contributions compound
      const investLumpRet = investNow * Math.pow(1 + investReturn, yearsToRetire);

      const months = yearsToRetire * 12;
      const rm = Math.pow(1 + investReturn, 1/12) - 1; // monthly rate
      let investContribRet = 0;
      if (months > 0 && monthlySavings > 0) {
        if (rm === 0) {
          investContribRet = monthlySavings * months;
        } else {
          investContribRet = monthlySavings * ((Math.pow(1 + rm, months) - 1) / rm);
        }
      }
      const investRet = investLumpRet + investContribRet;

      // Cash assumed 0% growth (simple)
      const cashRet = cashNow;

      const totalCapital = cpfRet + cashRet + investRet;

      // Required capital at retirement using PV of annuity (retirement drawdown)
      let requiredCapital = 0;
      if (retireReturn === 0) {
        requiredCapital = incomeAtRetireAnnual * retirementYears;
      } else {
        requiredCapital = incomeAtRetireAnnual * (1 - Math.pow(1 + retireReturn, -retirementYears)) / retireReturn;
      }

      const ratio = requiredCapital > 0 ? (totalCapital / requiredCapital) : 0;
      const gap = totalCapital - requiredCapital;

      // Conservative adjustment if many unknowns
      const unknownCount =
        Number($("cpfOAUnknown").checked) +
        Number($("cpfSAUnknown").checked) +
        Number($("cashUnknown").checked) +
        Number($("investUnknown").checked);

      let status = "bad";
      if (ratio >= 1.0) status = "good";
      else if (ratio >= 0.70) status = "warn";

      if (unknownCount >= 2) {
        if (status === "good") status = "warn";
        else if (status === "warn") status = "bad";
      }
      if (monthlySavings === 0 && ratio < 1.2 && status === "good") status = "warn";

      const statusLabel = (status === "good") ? "On Track" : (status === "warn") ? "At Risk" : "Not On Track";

      let msg = "";
      if (status === "good") {
        msg = `Based on your inputs, you appear broadly <b>on track</b>. Next step is to stress-test assumptions and look for <b>optimisation</b>.`;
      } else if (status === "warn") {
        msg = `There may be a <b>gap</b> between your goal and your current path. This is common and often <b>fixable</b> with adjustments.`;
      } else {
        msg = `Your inputs suggest a <b>significant gap</b> if nothing changes. The good news: spotting this early gives you <b>more options</b>.`;
      }

      const output = $("output");
      output.style.display = "block";

      output.innerHTML = `
        <div class="resultHero">
          <div class="resultHeroTop">
            <div class="resultBadge ${status}">
              <span class="dot"></span>
              ${statusLabel}
            </div>

            <div class="gaugeWrap">
              <div class="gauge ${status}" data-ratio="${ratio}">
                <svg viewBox="0 0 200 200" aria-hidden="true">
                  <circle class="track" cx="100" cy="100" r="80"></circle>
                  <circle class="progress" cx="100" cy="100" r="80"
                    stroke-dasharray="502.65"
                    stroke-dashoffset="502.65"></circle>
                </svg>

                <div class="gaugeCenter">
                  <p class="gaugeValue">${ratio.toFixed(2)}√ó</p>
                  <p class="gaugeLabel">Readiness ratio</p>
                </div>
              </div>

              <div class="gaugeHint">Estimated √∑ Required (higher is better). Target is <b>1.00√ó</b> or above.</div>
            </div>

            <p class="resultMsg">${msg}</p>
          </div>
        </div>

        <div class="metrics">
          <div class="metric">
            <p class="k">Years to retirement</p>
            <p class="v">${yearsToRetire}</p>
            <p class="s">retireAge - currentAge</p>
          </div>
          <div class="metric">
            <p class="k">Retirement years</p>
            <p class="v">${retirementYears}</p>
            <p class="s">longevityAge - retireAge</p>
          </div>
          <div class="metric">
            <p class="k">Income needed at retirement (annual)</p>
            <p class="v">$${fmtMoney(incomeAtRetireAnnual)}</p>
            <p class="s">inflation-adjusted</p>
          </div>
          <div class="metric">
            <p class="k">Required capital</p>
            <p class="v">$${fmtMoney(requiredCapital)}</p>
            <p class="s">PV of annuity</p>
          </div>
        </div>

        <div class="breakdown">
          <h4>Breakdown at retirement (age ${retireAge})</h4>
          <div class="breakdownGrid">
            <div class="item">
              <p class="label">CPF OA at retirement</p>
              <p class="value">$${fmtMoney(oaRet)}</p>
              <p class="sub">OA √ó (1+oaRate)^YTR</p>
            </div>
            <div class="item">
              <p class="label">CPF SA at retirement</p>
              <p class="value">$${fmtMoney(saRet)}</p>
              <p class="sub">SA √ó (1+saRate)^YTR</p>
            </div>
            <div class="item">
              <p class="label">Investments at retirement</p>
              <p class="value">$${fmtMoney(investRet)}</p>
              <p class="sub">lump + contributions</p>
            </div>
            <div class="item">
              <p class="label">Cash at retirement</p>
              <p class="value">$${fmtMoney(cashRet)}</p>
              <p class="sub">assumed 0% growth</p>
            </div>
            <div class="item">
              <p class="label">Estimated capital at retirement</p>
              <p class="value">$${fmtMoney(totalCapital)}</p>
              <p class="sub">CPF + cash + invest</p>
            </div>
            <div class="item">
              <p class="label">Surplus / shortfall</p>
              <p class="value">$${fmtMoney(gap)}</p>
              <p class="sub">estimated - required</p>
            </div>
          </div>
        </div>

        <details class="details">
          <summary>
            Calculation & Method
            <span class="chev">‚ñæ</span>
          </summary>
          <div class="content">
            <p><b>1) Inflation-adjusted income at retirement</b><br>
              <code>IncomeRetireMonthly = IncomeTodayMonthly √ó (1+inflation)^YTR</code><br>
              <code>IncomeRetireAnnual = IncomeRetireMonthly √ó 12</code>
            </p>

            <p><b>2) CPF growth</b><br>
              <code>OA_ret = OA_now √ó (1+oaRate)^YTR</code><br>
              <code>SA_ret = SA_now √ó (1+saRate)^YTR</code>
            </p>

            <p><b>3) Investment growth (lump + monthly contributions)</b><br>
              <code>Invest_lump = Invest_now √ó (1+investReturn)^YTR</code><br>
              Monthly rate: <code>rm = (1+investReturn)^(1/12) ‚àí 1</code><br>
              Future value of contributions:
              <code>FV = monthlySavings √ó ((1+rm)^(12√óYTR) ‚àí 1) / rm</code>
            </p>

            <p><b>4) Required capital at retirement (PV of annuity)</b><br>
              If retirement return <code>rr = 0</code>: <code>Required = IncomeAnnual √ó RY</code><br>
              Else:
              <code>Required = IncomeAnnual √ó (1 ‚àí (1+rr)^(-RY)) / rr</code>
            </p>

            <p><b>5) Readiness ratio</b><br>
              <code>Ratio = EstimatedCapital / RequiredCapital</code>
            </p>

            <p><b>Important:</b> This is a simplified educational model and does not include CPF contributions, CPF LIFE payouts, taxes, healthcare shocks, or scenario ranges.</p>
          </div>
        </details>
      `;

      paintGauge(status, ratio);
      output.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function resetAll(){
      ["currentAge","retireAge","monthlyIncome","monthlySavings","cpfOA","cpfSA","cash","invest"].forEach(id => $(id).value = "");

      $("longevityAge").value = "95";
      $("oaRate").value = "2.5";
      $("saRate").value = "4.0";
      $("investReturn").value = "5.0";
      $("inflation").value = "2.5";
      $("retireReturn").value = "3.0";

      ["cpfOAUnknown","cpfSAUnknown","cashUnknown","investUnknown"].forEach(id => $(id).checked = false);

      $("confidence").value = "";
      $("concern").value = "";

      ["cpfOA","cpfSA","cash","invest"].forEach((inputId) => $(inputId).disabled = false);

      $("output").style.display = "none";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    $("calcBtn").addEventListener("click", calculate);
    $("resetBtn").addEventListener("click", resetAll);
  </script>
</body>
</html>
